---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE } from '../consts';
import { getCollection } from 'astro:content';

const allPhotos = await getCollection('gallery');

// Helper to get Date for sorting (convert year-only to Jan 1 of that year)
function getDateForSorting(dateValue: Date | number | string | undefined): Date | null {
	if (!dateValue) return null;
	if (dateValue instanceof Date) return dateValue;
	// Year as number or string
	const year = typeof dateValue === 'number' ? dateValue : parseInt(dateValue, 10);
	return new Date(year, 0, 1); // January 1 of that year
}

// Helper to format date for display
function formatDate(dateValue: Date | number | string | undefined): string | undefined {
	if (!dateValue) return undefined;
	if (dateValue instanceof Date) {
		return dateValue.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
	}
	// Year-only: display as just the year
	return String(dateValue);
}

// Sort photos according to the requirements:
// 1. If order exists, sort by order ascending
// 2. Else if date exists, sort by date descending
// 3. Else sort alphabetically by title
const sortedPhotos = allPhotos.sort((a, b) => {
	// If both have order field, sort by order ascending
	if (a.data.order !== undefined && b.data.order !== undefined) {
		return a.data.order - b.data.order;
	}
	// If only one has order, prioritize it
	if (a.data.order !== undefined) return -1;
	if (b.data.order !== undefined) return 1;
	
	// If both have date, sort by date descending (newest first)
	const dateA = getDateForSorting(a.data.date);
	const dateB = getDateForSorting(b.data.date);
	if (dateA && dateB) {
		return dateB.getTime() - dateA.getTime();
	}
	// If only one has date, prioritize it
	if (dateA) return -1;
	if (dateB) return 1;
	
	// Otherwise sort alphabetically by title
	return a.data.title.localeCompare(b.data.title);
});

const photos = sortedPhotos.map(photo => ({
	title: photo.data.title,
	src: photo.data.src,
	alt: photo.data.alt,
	date: formatDate(photo.data.date),
	location: photo.data.location,
	camera: photo.data.camera,
	notes: photo.data.notes,
	slug: photo.data.slug,
}));
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Gallery - ${SITE_TITLE}`} description="Photography gallery" />
		<style>
			.gallery-container {
				max-width: 1400px;
				margin: 0 auto;
				padding: 2em 1em;
			}

			.gallery-header {
				margin-bottom: 2em;
				text-align: center;
			}

			.gallery-header h1 {
				margin-bottom: 0.5em;
			}

			.empty-state {
				text-align: center;
				padding: 4em 2em;
				color: var(--text-secondary);
			}

			.gallery-viewer {
				display: grid;
				grid-template-columns: 1fr 350px;
				gap: 2em;
				align-items: start;
			}

			.image-area {
				position: relative;
				background: var(--bg);
				border-radius: var(--radius-md);
				overflow: hidden;
				min-height: 500px;
				display: flex;
				align-items: center;
				justify-content: center;
				border: 1px solid transparent;
			}
			
			/* Gradient border for image area */
			.image-area::before {
				content: '';
				position: absolute;
				inset: -1px;
				border-radius: var(--radius-md);
				padding: 1px;
				background: var(--fine-border-gradient);
				-webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
				-webkit-mask-composite: xor;
				mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
				mask-composite: exclude;
				pointer-events: none;
				z-index: -1;
			}

			.main-image {
				width: 100%;
				height: auto;
				display: block;
				max-height: 80vh;
				object-fit: contain;
				border-radius: var(--radius-md);
			}

			.details-nav {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 1rem;
			}

			.nav-button {
				background: var(--surface-1);
				border: 1px solid var(--border);
				width: 48px;
				height: 48px;
				border-radius: 50%;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 24px;
				color: var(--text);
				transition: all 0.2s;
			}

			.nav-button:hover:not(:disabled) {
				background: var(--surface-1-hover);
				border-color: var(--glass-border-hover);
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
			}

			.nav-button:focus-visible {
				outline: var(--focus-ring);
				outline-offset: 2px;
			}

			.nav-button:disabled {
				opacity: 0.4;
				cursor: not-allowed;
				color: var(--text-secondary);
			}

			.metadata-sidebar {
				padding: 2em;
			}

			.metadata-sidebar h2 {
				font-size: 1.5em;
				margin-top: 0;
				margin-bottom: 0.5em;
				color: var(--text);
			}

			.gallery-meta {
				margin-top: 1.5em;
			}

			.counter {
				text-align: center;
				margin-top: 1em;
				padding-top: 1em;
				border-top: 1px solid var(--border);
				font-size: 0.9em;
				color: var(--text-secondary);
			}

			@media (max-width: 1024px) {
				.gallery-viewer {
					grid-template-columns: 1fr;
				}

				.metadata-sidebar {
					order: 2;
				}

				.image-area {
					order: 1;
				}

				.nav-button {
					width: 40px;
					height: 40px;
					font-size: 20px;
				}
			}

			@media (max-width: 720px) {
				.gallery-container {
					padding: 1em 0.5em;
				}

				.metadata-sidebar {
					padding: 1.5em;
				}

				.image-area {
					min-height: 300px;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<div class="gallery-container">
			<div class="gallery-header">
				<h1>Gallery</h1>
			</div>

			{photos.length === 0 ? (
				<div class="empty-state">
					<p>No photos in the gallery yet.</p>
				</div>
			) : (
				<div class="gallery-viewer">
					<div class="image-area">
						<img 
							id="mainImage" 
							class="main-image" 
							src={photos[0].src} 
							alt={photos[0].alt}
						/>
					</div>

					<div class="metadata-sidebar glass-panel glass-panel-static">
						<div class="details-nav">
							<button class="nav-button prev" id="prevBtn" aria-label="Previous photo">‹</button>
							<button class="nav-button next" id="nextBtn" aria-label="Next photo">›</button>
						</div>
						<h2 id="photoTitle">{photos[0].title}</h2>
						
						<dl class="gallery-meta" id="metadataContainer">
							{photos[0].date && (
								<>
									<dt>Date</dt>
									<dd id="photoDate">{photos[0].date}</dd>
								</>
							)}
							
							{photos[0].location && (
								<>
									<dt>Location</dt>
									<dd id="photoLocation">{photos[0].location}</dd>
								</>
							)}
							
							{photos[0].camera && (
								<>
									<dt>Camera</dt>
									<dd id="photoCamera">{photos[0].camera}</dd>
								</>
							)}
							
							{photos[0].notes && (
								<>
									<dt>Notes</dt>
									<dd id="photoNotes">{photos[0].notes}</dd>
								</>
							)}
						</dl>

						<div class="counter">
							<span id="currentIndex">1</span> / <span id="totalCount">{photos.length}</span>
						</div>
					</div>
				</div>
			)}
		</div>
		<Footer />

		<script define:vars={{ photos }}>
			if (photos.length > 0) {
				let currentIndex = 0;

				// Get initial index from URL query param
				const urlParams = new URLSearchParams(window.location.search);
				const urlIndexParam = urlParams.get('i');
				
				if (urlIndexParam) {
					// Try to match by slug first
					const slugIndex = photos.findIndex(p => p.slug && p.slug === urlIndexParam);
					if (slugIndex !== -1) {
						currentIndex = slugIndex;
					} else {
						// Fall back to numeric index (1-based from URL, convert to 0-based)
						const numericIndex = parseInt(urlIndexParam);
						if (!isNaN(numericIndex) && numericIndex >= 1 && numericIndex <= photos.length) {
							currentIndex = numericIndex - 1;
						}
					}
				}

				const mainImage = document.getElementById('mainImage');
				const prevBtn = document.getElementById('prevBtn');
				const nextBtn = document.getElementById('nextBtn');
				const photoTitle = document.getElementById('photoTitle');
				const currentIndexEl = document.getElementById('currentIndex');
				const metadataContainer = document.getElementById('metadataContainer');

				function updateDisplay() {
					const photo = photos[currentIndex];
					
					// Update image
					mainImage.src = photo.src;
					mainImage.alt = photo.alt;
					
					// Update title
					photoTitle.textContent = photo.title;
					
					// Update counter
					currentIndexEl.textContent = currentIndex + 1;
					
					// Update metadata
					let metadataHTML = '';
					
					if (photo.date) {
						metadataHTML += `
							<dt>Date</dt>
							<dd>${photo.date}</dd>
						`;
					}
					
					if (photo.location) {
						metadataHTML += `
							<dt>Location</dt>
							<dd>${photo.location}</dd>
						`;
					}
					
					if (photo.camera) {
						metadataHTML += `
							<dt>Camera</dt>
							<dd>${photo.camera}</dd>
						`;
					}
					
					if (photo.notes) {
						metadataHTML += `
							<dt>Notes</dt>
							<dd>${photo.notes}</dd>
						`;
					}
					
					metadataContainer.innerHTML = metadataHTML;
					
					// Update URL - prefer slug if available, otherwise use 1-based numeric index
					const newUrl = new URL(window.location);
					const urlParam = photo.slug ? photo.slug : (currentIndex + 1).toString();
					newUrl.searchParams.set('i', urlParam);
					window.history.pushState({}, '', newUrl);
				}

				function showPrevious() {
					currentIndex = (currentIndex - 1 + photos.length) % photos.length;
					updateDisplay();
				}

				function showNext() {
					currentIndex = (currentIndex + 1) % photos.length;
					updateDisplay();
				}

				// Button click handlers
				prevBtn.addEventListener('click', showPrevious);
				nextBtn.addEventListener('click', showNext);

				// Keyboard navigation
				document.addEventListener('keydown', (e) => {
					if (e.key === 'ArrowLeft') {
						showPrevious();
					} else if (e.key === 'ArrowRight') {
						showNext();
					}
				});

				// Initialize display with URL index
				updateDisplay();
			}
		</script>
	</body>
</html>
