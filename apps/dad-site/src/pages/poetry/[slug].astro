---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import PoetryDarkReaderToggle from '../../components/PoetryDarkReaderToggle.astro';
import { getEntry, render } from 'astro:content';
import { slugifyTag } from '../../utils/tags';

// Get the slug from the URL params
const { slug } = Astro.params;

// Fetch the entry at runtime
const poem = slug ? await getEntry('poetry', slug) : undefined;

// If no poem found, return 404
if (!poem) {
	return new Response(null, {
		status: 404,
		statusText: 'Not found'
	});
}

const { Content } = await render(poem);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead 
			title={`${poem.data.title} | Charles Slater`}
			description={poem.data.excerpt}
		/>
	</head>
	<body>
		<Header />
		<main>
			<PoetryDarkReaderToggle />
			
			<div class="poetry-reader-surface" data-poetry-reader>
				<article>
					<header class="poem-header">
						<h1>{poem.data.title}</h1>
						<div class="poem-meta">
							<FormattedDate date={poem.data.date} />
						</div>
						{poem.data.tags && poem.data.tags.length > 0 && (
							<div class="tags">
								{poem.data.tags.map((tag: string) => (
									<a href={`/poetry/tags/${slugifyTag(tag)}`} class="tag">
										{tag}
									</a>
								))}
							</div>
						)}
					</header>

					<div class="poem-content">
						<Content />
					</div>

					<footer class="poem-footer">
						<a href="/poetry" class="back-link">‚Üê Back to all poems</a>
					</footer>
				</article>
			</div>
		</main>
		<Footer />
	</body>
</html>

<style>
	.poem-header {
		margin-bottom: 3em;
		padding-bottom: 2em;
		border-bottom: 1px solid var(--border);
	}

	h1 {
		margin-bottom: 0.5em;
	}

	.poem-meta {
		color: var(--muted);
		font-size: 0.95em;
		margin-bottom: 1em;
	}

	.tags {
		display: flex;
		gap: 0.5em;
		flex-wrap: wrap;
		margin-top: 1em;
	}

	.tag {
		background: var(--surface-2);
		border: 1px solid var(--storm-grey-2);
		padding: 0.25em 0.75em;
		border-radius: var(--radius-sm);
		font-size: 0.85em;
		color: var(--muted);
		text-decoration: none;
		display: inline-block;
		transition: all 0.2s ease;
	}

	.tag:hover {
		background: var(--accent);
		color: white;
		border-color: var(--accent-hover);
	}

	.poem-content {
		white-space: pre-wrap;
		font-family: Georgia, 'Times New Roman', serif;
		line-height: 1.9;
		margin: 2em 0;
		color: var(--text);
	}

	.poem-footer {
		margin-top: 3em;
		padding-top: 2em;
		border-top: 1px solid var(--border);
	}

	.back-link {
		color: var(--accent);
		text-decoration: none;
		font-size: 0.95em;
	}

	.back-link:hover {
		text-decoration: underline;
		color: var(--accent-hover);
	}
