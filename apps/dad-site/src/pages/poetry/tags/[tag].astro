---
import BaseHead from '../../../components/BaseHead.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import PoetryDarkReaderToggle from '../../../components/PoetryDarkReaderToggle.astro';
import { getCollection } from 'astro:content';
import { slugifyTag, getTagSlugMap } from '../../../utils/tags';

export const prerender = true;

// Generate static paths for all tags
export async function getStaticPaths() {
	const tagSlugMap = await getTagSlugMap();
	return Array.from(tagSlugMap.entries()).map(([slug, originalTag]) => ({
		params: { tag: slug },
		props: { originalTag }
	}));
}

// Get the tag slug from URL params and original tag from props
const { tag } = Astro.params;
const { originalTag } = Astro.props;

// Get all poems
const allPoems = await getCollection('poetry');

// Filter poems that have this tag
const poemsWithTag = allPoems.filter(poem => {
	if (!poem.data.tags || !Array.isArray(poem.data.tags)) {
		return false;
	}
	return poem.data.tags.some(t => slugifyTag(t) === tag);
});

// Sort by date ascending (oldest first)
poemsWithTag.sort((a, b) => a.data.date.valueOf() - b.data.date.valueOf());
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead 
			title={`Tag: ${originalTag} | Charles Slater`}
			description={`Poems tagged with ${originalTag}`}
		/>
	</head>
	<body>
		<Header />
		<main>
			<h1>Tag: {originalTag}</h1>
			
			<PoetryDarkReaderToggle />

			<div class="poetry-reader-surface" data-poetry-reader>
				{poemsWithTag.length === 0 ? (
					<p class="no-poems">No poems found with this tag.</p>
				) : (
					<ul class="tag-poems-list">
						{poemsWithTag.map(poem => {
							const year = poem.data.date ? new Date(poem.data.date).getFullYear() : null;
							const hasValidYear = year && !Number.isNaN(year);
							const hasExcerpt = poem.data.excerpt && poem.data.excerpt.trim().length > 0;
							
							return (
								<li class="tag-poem-item">
									<div class="tag-poem-titleline">
										<a href={`/poetry/${poem.id}`} class="poem-link">{poem.data.title}</a>{hasValidYear && (
											<span class="tag-poem-year"> / {year}</span>
										)}
									</div>
									{hasExcerpt && (
										<p class="tag-poem-excerpt">{poem.data.excerpt}</p>
									)}
								</li>
							);
						})}
					</ul>
				)}

				<div class="back-link-container">
					<a href="/poetry" class="back-link">‚Üê Back to all poems</a>
				</div>
			</div>
		</main>
		<Footer />
	</body>
</html>

<style>
	h1 {
		margin-bottom: 2em;
	}

	.no-poems {
		color: var(--text-secondary);
		font-style: italic;
		margin: 2em 0;
	}

	.tag-poems-list {
		list-style: none;
		padding: 0;
		margin: 0 0 3em 0;
		display: flex;
		flex-direction: column;
		gap: 1.5em;
	}

	.tag-poem-item {
		padding: 0;
		margin: 0;
	}

	.tag-poem-titleline {
		display: block;
		line-height: 1.4;
	}

	.poem-link {
		display: inline;
		padding: 0;
		margin: 0;
		color: var(--text);
		text-decoration: none;
		font-size: 1.1em;
		font-weight: 500;
		transition: color 0.2s ease;
	}

	.poem-link:hover {
		text-decoration: underline;
	}

	.tag-poem-year {
		color: var(--text-secondary);
		font-size: 0.95em;
		font-weight: 400;
		white-space: nowrap;
	}

	.tag-poem-excerpt {
		color: var(--text-secondary);
		margin-top: 0.35rem;
		margin-bottom: 0;
		font-size: 0.98em;
		line-height: 1.5;
	}
</style>
