---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import { getEntry, render } from 'astro:content';

// Get the slug from the URL params
const { slug } = Astro.params;

// Fetch the entry at runtime
const novel = slug ? await getEntry('novels', slug) : undefined;

// If no novel found, return 404
if (!novel) {
	return new Response(null, {
		status: 404,
		statusText: 'Not found'
	});
}

const { Content } = await render(novel);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead 
			title={`${novel.data.title} | Charles Slater`}
			description={novel.data.synopsis}
		/>
	</head>
	<body>
		<Header />
		<main>
			<article class="glass-panel glass-panel--padded glass-panel-static novel-surface">
				<header class="novel-header">
					<h1>{novel.data.title}</h1>
					
					<div class="novel-info">
						{novel.data.publicationDate && (
							<div class="info-item">
								<strong>Published:</strong>{' '}
								<FormattedDate date={novel.data.publicationDate} />
							</div>
						)}
						{novel.data.printLength && (
							<div class="info-item">
								<strong>Length:</strong> {novel.data.printLength} pages
							</div>
						)}
					</div>

					{novel.data.purchaseLinks && novel.data.purchaseLinks.length > 0 && (
						<div class="purchase-links">
							<h3>Purchase</h3>
							<div class="links">
								{novel.data.purchaseLinks.map((link) => (
									<a href={link.url} target="_blank" rel="noopener noreferrer" class="purchase-link">
										{link.label}
									</a>
								))}
							</div>
						</div>
					)}

					<div class="synopsis">
						<h3>Synopsis</h3>
						<p>{novel.data.synopsis}</p>
					</div>
				</header>

				<div class="novel-content">
					<Content />
				</div>

				<footer class="novel-footer">
					<a href="/novels" class="back-link">‚Üê Back to all novels</a>
				</footer>
			</article>
		</main>
		<Footer />
	</body>
</html>

<style>
	.novel-surface {
		margin-bottom: 2em;
	}

	.novel-header {
		margin-bottom: 3em;
	}

	h1 {
		margin-bottom: 1em;
	}

	.novel-info {
		display: flex;
		flex-direction: column;
		gap: 0.5em;
		margin-bottom: 2em;
		color: var(--muted);
		font-size: 0.95em;
	}

	.info-item strong {
		color: var(--storm-grey-3);
	}

	.purchase-links {
		margin-bottom: 2em;
		padding: 1.5em;
		background: var(--surface-2);
		border-radius: var(--radius-md);
		border: 1px solid var(--border);
	}

	.purchase-links h3 {
		margin-top: 0;
		margin-bottom: 1em;
		font-size: 1.2em;
	}

	.links {
		display: flex;
		gap: 1em;
		flex-wrap: wrap;
	}

	.purchase-link {
		display: inline-block;
		padding: 0.75em 1.5em;
		background: var(--accent);
		color: white;
		text-decoration: none;
		border-radius: 4px;
		font-weight: 500;
		transition: background 0.2s;
	}

	.purchase-link:hover {
		background: var(--accent-hover);
	}

	.synopsis {
		margin-bottom: 2em;
		padding-bottom: 2em;
		border-bottom: 1px solid var(--border);
	}

	.synopsis h3 {
		margin-bottom: 1em;
		font-size: 1.3em;
	}

	.synopsis p {
		line-height: 1.7;
		color: var(--storm-grey-3);
	}

	.novel-content {
		line-height: 1.8;
		margin: 2em 0;
		color: var(--text);
	}

	.novel-content :global(img) {
		margin: 2em 0;
	}

	.novel-footer {
		margin-top: 3em;
		padding-top: 2em;
		border-top: 1px solid var(--border);
	}

	/* Make hover state permanent for this surface */
	.glass-panel-static {
		background: var(--surface-1-hover);
		border-color: var(--glass-border-hover);
	}
</style>
